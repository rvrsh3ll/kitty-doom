---
name: CI

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # Build flags
  CFLAGS: "-Wall -Wextra -Werror"

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.name }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux with GCC
          - name: "Linux (GCC)"
            os: ubuntu-latest
            compiler: gcc
          # Linux with Clang
          - name: "Linux (Clang)"
            os: ubuntu-latest
            compiler: clang
          # macOS (Clang only, gcc is an alias on macOS)
          - name: "macOS (Clang)"
            os: macos-latest
            compiler: clang

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download external dependencies
        run: make download-assets

      - name: Build and test
        env:
          CC: ${{ matrix.compiler }}
        run: |
          make
          make check

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck file lsb-release wget software-properties-common gnupg

          # Install clang-format-21 from apt.llvm.org (official LLVM repository)
          # Version 21.x allows minor updates (e.g., 21.1.x -> 21.2.x) for bug fixes
          # while maintaining formatting consistency. CI becomes the definitive formatter.
          # GPG key fingerprint: 6084 F3CF 814B 57C1 CF12 EFD5 15CF 4D18 AF4F 7421
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc

          # Verify GPG key fingerprint (optional but recommended for security)
          KEY_FP=$(gpg --with-colons --import-options show-only --import /etc/apt/trusted.gpg.d/apt.llvm.org.asc 2>/dev/null | awk -F: '/^fpr:/ {print $10; exit}')
          if [ "$KEY_FP" != "6084F3CF814B57C1CF12EFD515CF4D18AF4F7421" ]; then
            echo "Warning: GPG key fingerprint mismatch. Expected: 6084F3CF814B57C1CF12EFD515CF4D18AF4F7421, Got: $KEY_FP"
          fi

          sudo add-apt-repository -y "deb http://apt.llvm.org/$(lsb_release -sc)/ llvm-toolchain-$(lsb_release -sc)-21 main"
          sudo apt-get update
          sudo apt-get install -y clang-format-21

          # Install shfmt for shell script formatting (honors .editorconfig)
          curl -sSL https://github.com/mvdan/sh/releases/download/v3.12.0/shfmt_v3.12.0_linux_amd64 -o /tmp/shfmt
          chmod +x /tmp/shfmt
          sudo mv /tmp/shfmt /usr/local/bin/shfmt

      - name: Download external dependencies
        run: make download-assets

      - name: Run cppcheck
        run: |
          # Only check our own code, skip main.c (includes 48K-line PureDOOM.h)
          # Suppress miniaudio.h errors (we check sound.c logic, not miniaudio internals)
          # Optimizations: -j4 (parallel), --max-configs=2 (limit combinations),
          # --platform=unix64 (CI-specific), --check-level=normal (explicit)
          cppcheck --enable=warning,performance,portability \
                   --check-level=normal \
                   --platform=unix64 \
                   --max-configs=2 \
                   --error-exitcode=1 \
                   --suppress=missingIncludeSystem \
                   --suppress='*:src/miniaudio.h' \
                   --inline-suppr \
                   -j 4 \
                   $(git ls-files 'src/*.c' 'src/*.h' | \
                     grep -v 'main.c' | \
                     grep -v 'PureDOOM.h' | \
                     grep -v 'profiling.h') \
                   2>&1 | tee cppcheck-report.txt

      - name: Upload cppcheck report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.txt

      - name: Check code formatting
        run: .ci/check-format.sh

      - name: Check newline at end of files
        run: .ci/check-newline.sh

  performance-check:
    name: Performance Regression Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download external dependencies
        run: make download-assets

      - name: Build with profiling and tests
        run: |
          make clean
          make profile
          make build/tests/bench-base64 build/tests/bench-palette

      - name: Run performance benchmarks
        run: |
          # Run unit-level performance tests (no terminal required)
          ./build/tests/bench-base64 > bench-base64.txt
          ./build/tests/bench-palette > bench-palette.txt

          echo "=== Base64 Benchmark ==="
          cat bench-base64.txt

          echo "=== Palette Benchmark ==="
          cat bench-palette.txt

      - name: Compare with baseline (informational)
        continue-on-error: true
        run: |
          # Note: This is informational only
          # Full performance testing requires terminal interaction
          if [ -f tests/performance/baseline-current.txt ]; then
            echo "Baseline comparison:"
            cat tests/performance/baseline-current.txt
          else
            echo "No baseline found - manual profiling required"
          fi

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            bench-base64.txt
            bench-palette.txt

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download external dependencies
        run: make download-assets

      - name: Build with sanitizers
        run: |
          # AddressSanitizer
          make clean
          CFLAGS="-fsanitize=address -fno-omit-frame-pointer -g" make

          # Run tests with ASan
          make check

          # UndefinedBehaviorSanitizer
          make clean
          CFLAGS="-fsanitize=undefined -fno-omit-frame-pointer -g" make

          # Run tests with UBSan
          make check

  kitty-integration:
    name: Kitty Graphics Integration Test
    runs-on: ubuntu-latest
    continue-on-error: true  # Informational, not blocking

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Kitty + tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            mesa-utils \
            libgl1-mesa-dri \
            scrot \
            imagemagick \
            bc

          # Download and install latest prebuilt Kitty binary
          # Use official installer from https://sw.kovidgoyal.net/kitty/binary/
          echo "Installing latest Kitty from official prebuilt binary..."
          curl -fsSL https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin

          # Verify installation directory exists
          if [ ! -d "$HOME/.local/kitty.app/bin" ]; then
            echo "❌ Kitty installation failed: directory not found"
            exit 1
          fi

          # Add Kitty to PATH for subsequent steps
          echo "$HOME/.local/kitty.app/bin" >> $GITHUB_PATH

          # Verify binary is executable and show version
          KITTY_BIN="$HOME/.local/kitty.app/bin/kitty"
          if [ ! -x "$KITTY_BIN" ]; then
            echo "❌ Kitty binary not executable"
            exit 1
          fi

          echo "✅ Kitty installed successfully:"
          $KITTY_BIN --version

      - name: Download external dependencies
        run: make download-assets

      - name: Build kitty-doom
        run: make

      - name: Smoke test (launch + auto-quit)
        timeout-minutes: 1
        run: |
          # Auto-quit after 3 seconds with 'q' key
          # Hard timeout at 10s to prevent infinite hangs
          # DBus warnings are harmless - real issue is game auto-exit
          (sleep 3 && echo 'q') | \
          timeout 10s \
          xvfb-run -a -s "-screen 0 1024x768x24" \
            env KITTY_DISABLE_WAYLAND=1 \
            kitty --config NONE --detach=no ./build/kitty-doom -nosound \
          || true

          echo "✅ Kitty integration smoke test completed (exit via timeout is expected)"

      - name: Visual verification test
        timeout-minutes: 2
        run: |
          # Launch game and capture screenshot (with proper DISPLAY handling)
          # Hard timeout at 15s - DBus warnings are harmless noise
          XVFB_EXIT=0
          timeout 15s xvfb-run -a -s "-screen 0 1024x768x24" sh -c '
            # Start kitty-doom in background (Wayland disabled for X11 only)
            env KITTY_DISABLE_WAYLAND=1 \
              kitty --config NONE --detach=no ./build/kitty-doom -nosound &
            GAME_PID=$!

            # Wait longer for game to render (title screen appears)
            # 4 seconds to account for slow CI runners
            sleep 4

            # Capture screenshot (inherit $DISPLAY from xvfb-run)
            scrot /tmp/kitty-doom-screenshot.png 2>&1 | tee /tmp/scrot.log || \
              import -window root /tmp/kitty-doom-screenshot.png 2>&1 | tee /tmp/import.log

            # Kill game
            kill $GAME_PID 2>/dev/null || true
            wait $GAME_PID 2>/dev/null || true
          ' || XVFB_EXIT=$?

          # Log xvfb-run exit code for debugging
          if [ $XVFB_EXIT -ne 0 ]; then
            echo "⚠️ xvfb-run exited with code $XVFB_EXIT"
          fi

          # Verify screenshot was captured
          if [ -f /tmp/kitty-doom-screenshot.png ]; then
            echo "✅ Screenshot captured successfully"

            # Get screenshot dimensions and verify correctness
            SIZE=$(identify -format "%wx%h" /tmp/kitty-doom-screenshot.png)
            echo "Screenshot size: $SIZE"

            # Assert expected dimensions
            if [ "$SIZE" != "1024x768" ]; then
              echo "❌ Unexpected screenshot size: $SIZE (expected 1024x768)"
              exit 1
            fi

            # DOOM-specific visual validation (4-level checks)
            .ci/check-visual.sh /tmp/kitty-doom-screenshot.png
          else
            echo "⚠️ Screenshot capture failed"
            # Show capture tool logs if available
            [ -f /tmp/scrot.log ] && echo "scrot log:" && cat /tmp/scrot.log
            [ -f /tmp/import.log ] && echo "import log:" && cat /tmp/import.log
            exit 1
          fi

      # Optional: Add demo playback test when demo file is created
      # - name: Demo playback test
      #   timeout-minutes: 1
      #   run: |
      #     if [ -f tests/smoke_test.lmp ]; then
      #       xvfb-run -a -s "-screen 0 1024x768x24" \
      #         kitty --config NONE \
      #         ./build/kitty-doom -nosound -playdemo tests/smoke_test.lmp
      #       echo "✅ Demo playback completed"
      #     else
      #       echo "⏭️ No demo file found, skipping"
      #     fi
